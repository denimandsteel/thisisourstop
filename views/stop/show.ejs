<header>
  <a href="/"><img width="134" height"81" id="logo" src="/logo.png" /></a>
  <div id="stop_id"><%= stop.id %></div>
  <form id="stop_form" class="hide" method="post" action="/">
  	<input name="stop" id="stop" type="text" pattern="[0-9]*" value="<%= stop.id %>" />
  	<input class="btn" type="submit" value="Go" />
  </form>
</header>

<div class="map">
  <div class="notch top"></div>
  <img id="map" width="320" height="200" src="http://maps.googleapis.com/maps/api/staticmap?center=<%= stop.stop_lat %>,<%= stop.stop_lon %>&amp;zoom=15&amp;size=320x200&amp;maptype=&amp;markers=<%= stop.stop_lat %>,<%= stop.stop_lon %>&amp;sensor=false&amp;scale=2" />
  <div class="notch bottom"></div>
</div>

<div id="stop-info">
  <div class="stop_desc"><%- stop.stop_desc %></div>
  <div class="trips">
    <%- partial('trip', stop.trip) %>
  </div>
  <!--<a class="button" href="http://maps.google.com/maps?ll=<%= stop.stop_lat %>,<%= stop.stop_lon %>">Open in Maps</a>
  <a class="button" href="http://nb.translink.ca/Map/Stop/<%= stop.id %>">Open in TransLink Mobile</a>-->
</div>

<div id="stop-talk">
  <form id="new-comment" method="post" action="/stop/<%= stop.id %>">
    <div class="icons">
      <img width="64" height="64" class="icon" id="weather" src="/weather.png" />
      <img width="64" height="64" class="icon" id="look_for" src="/look_for.png" />
      <img width="64" height="64" class="icon" id="suggestion" src="/suggestion.png" />
      <img width="64" height="64" class="icon last" id="just_sayin" src="/just_sayin.png" />
    </div>

    <input class="checkboxes" type="checkbox" name="type[weather]" value="weather" />
    <input class="checkboxes" type="checkbox" name="type[suggestion]" value="suggestion" />
    <input class="checkboxes" type="checkbox" name="type[look_for]" value="look_for" />
    <input class="checkboxes" type="checkbox" name="type[just_sayin]" value="just_sayin" />

    <div id="post-body">
      <div id="post-header"><span class="minor">Talk About</span> This Stop</div>
      <div id="count">200</div>
      <textarea id="text" name="comment"></textarea>

      <div class="actions">
        <input class="btn primary" type="submit" value="Post It" />
      </div>
    </div>
  </form>
  <div id="comments">
<%- partial('comment', comments) %>
  </div>

  <% if (comments.length > 0) { %>
  <a class="button" href="#new-comment">Talk About This Stop</a>
  <% } else { %>
  <div id="quiet">Pretty quiet in here... say something!</div>
  <% } %>

  <a id="another-stop" class="button" href="#stop">Find Another Stop</a>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/ejs.min.js"></script>
  <script id="comment-template" type="text/template">
<%- comment_template %>
  </script>

  <script type="text/javascript">
  /*
   * Based on John Resig's Pretty Date: http://ejohn.org/blog/javascript-pretty-date/
   * Licensed under the MIT and GPL licenses.
   */

  // Takes an ISO time and returns a string representing how
  // long ago the date represents.
  function prettyDate(time){
    console.log('made it prettyDate?');
    console.log(time);
    var date = new Date(time),
      diff = (((new Date()).getTime() - date.getTime()) / 1000),
      day_diff = Math.floor(diff / 86400);

    if ( isNaN(day_diff) || day_diff < 0 || day_diff >= 31 )
      return;

    return day_diff == 0 && (
        diff < 60 && "Just now" ||
        diff < 120 && "1 minute ago" ||
        diff < 3600 && Math.floor( diff / 60 ) + " minutes ago" ||
        diff < 7200 && "1 hour ago" ||
        diff < 86400 && Math.floor( diff / 3600 ) + " hours ago") ||
      day_diff == 1 && "Yesterday" ||
      day_diff < 7 && day_diff + " days ago" ||
      day_diff < 31 && Math.ceil( day_diff / 7 ) + " weeks ago";
  }

  var ejs = require('ejs');

  ejs.filters.time = function(milliseconds) {
    console.log('made it time?');
    console.log(milliseconds);
    return prettyDate(milliseconds);
  };

  var socket = io.connect();

  var commentTemplate = ejs.compile($('#comment-template').html());

  var insertComment = function(data) {
    var comment = data.comment;
    // if data.error === true then prepend to comment form with data.message
    var html = $(commentTemplate({ comment: comment, new_comment: true })).hide();
    $('#comments').prepend(html);
    html.slideDown();
  }
  socket.on('stop/<%= stop.id %>', insertComment);

  // http://api.jquery.com/focusin/ for showing when something is typing.

  $('#new-comment').submit(function() {
      var types = {};
      $.each($("#new-comment input:checked"), function() {
        var val = $(this).val();
        types[val] = 'on';
      });
      socket.emit('new', {
        comment : $('#new-comment textarea').val(),
        stop: <%= stop.id %>,
        types: types
      });
      $('#new-comment textarea').val('');
      $('#new-comment .icon').removeClass('active');
      $('#new-comment input[type=checkbox]').attr('checked', false);

      /*
      $.post($(this).attr('action'), $(this).serialize(), function(data) {
        if (data.error === false) {
          $('#new-comment textarea').val('');
          $('#new-comment .icon').removeClass('active');
          $('#new-comment input[type=checkbox]').attr('checked', false);

          // If socket not connected, take care of insertion.
          if (socket.socket.connected !== true) {
            insertComment(data);
          }
        }
      });
      */
      return false;
  });

  $('textarea#text').keyup(function() {
    $('#count').html(200 - $(this).val().length);
  });

  $('.comment .actions a').click(function(evt) {
    var el = $(this);
    // Should probably be sending with the socket.
    $.get(el.attr('href'), function(data) {
      el.parents('.comment').replaceWith(commentTemplate({ comment: data.comment, new_comment: true }));
    });
    return false;
  });

  // Also look at: http://cubiq.org/remove-onclick-delay-on-webkit-for-iphone
  // And: http://code.google.com/mobile/articles/fast_buttons.html
  $('#new-comment .icon').toggle(function() {
    $(this).addClass('active');
    $('#new-comment input[name="type[' + $(this).attr('id') + ']"]').attr('checked', true);
  }, function() {
    $(this).removeClass('active');
    $('#new-comment input[name="type[' + $(this).attr('id') + ']"]').attr('checked', false);
  });

  $('#another-stop').click(function() {
    $('#stop_id').hide();
    $('#stop_form').show();
    window.scrollTo(0,0);
    $('#stop').val('').focus();
    return false;
  });

  $('#stop_id').click(function() {
    $(this).hide();
    $('#stop_form').show();
  });
  </script>
</div>

<header>
  <a href="/"><img width="134" height"81" id="logo" src="/logo.png" /></a>
  <div id="stop_id"><%= stop.id %></div>
  <form id="stop_form" class="hide" method="post" action="/">
  	<input name="stop" id="stop" type="text" pattern="[0-9]*" value="<%= stop.id %>" />
  	<input class="btn" type="submit" value="Go" />
  </form>
</header>

<div class="map">
  <div class="notch top"></div>
  <img id="map" width="320" height="200" src="http://maps.googleapis.com/maps/api/staticmap?center=<%= stop.stop_lat %>,<%= stop.stop_lon %>&amp;zoom=15&amp;size=320x200&amp;maptype=&amp;markers=<%= stop.stop_lat %>,<%= stop.stop_lon %>&amp;sensor=false&amp;scale=2" />
  <div class="notch bottom"></div>
</div>

<div id="stop-info">
  <div class="stop_desc"><%- stop.stop_desc %></div>
  <div class="trips">
    <%- partial('trip', stop.trip) %>
  </div>
  <!--<a class="button" href="http://maps.google.com/maps?ll=<%= stop.stop_lat %>,<%= stop.stop_lon %>">Open in Maps</a>
  <a class="button" href="http://nb.translink.ca/Map/Stop/<%= stop.id %>">Open in TransLink Mobile</a>-->
</div>

<div id="stop-talk">
  <form id="new-comment" method="post" action="/stop/<%= stop.id %>">

    <img width="64" height="64" class="icon" id="weather" src="/weather.png" />
    <img width="64" height="64" class="icon" id="suggestion" src="/look_for.png" />
    <img width="64" height="64" class="icon" id="look_for" src="/suggestion.png" />
    <img width="64" height="64" class="icon last" id="just_sayin" src="/just_sayin.png" />

    <input class="checkboxes" type="checkbox" name="type[weather]" />
    <input class="checkboxes" type="checkbox" name="type[suggestion]" />
    <input class="checkboxes" type="checkbox" name="type[look_for]" />
    <input class="checkboxes" type="checkbox" name="type[just_sayin]" />

    <div id="post-body">
      <div id="post-header"><span class="minor">Talk About</span> This Stop</div>
      <div id="count">0/200</div>
      <textarea id="text" name="comment"></textarea>

      <div class="actions">
        <input class="btn primary" type="submit" value="Post It" />
      </div>
    </div>
  </form>

  <%- partial('comment', comments) %>

  <% if (comments.length > 0) { %>
  <a class="button" href="#new-comment">Talk About This Stop</a>
  <% } else { %>
  <div id="quiet">Pretty quiet in here... say something!</div>
  <% } %>

  <a id="another-stop" class="button" href="#stop">Find Another Stop</a>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js"></script>
  <script type="text/javascript">
  // From: http://cubiq.org/remove-onclick-delay-on-webkit-for-iphone
  function NoClickDelay(el) {
    console.log(el);
    this.element = el;
    this.element.addEventListener('touchstart', this, false);
  }

  NoClickDelay.prototype = {
    handleEvent: function(e) {
      console.log('oh?');
      switch(e.type) {
        case 'touchstart': this.onTouchStart(e); break;
        case 'touchmove': this.onTouchMove(e); break;
        case 'touchend': this.onTouchEnd(e); break;
      }
    },

    onTouchStart: function(e) {
      console.log('ok?');
      e.preventDefault();
      this.moved = false;

      this.element.addEventListener('touchmove', this, false);
      this.element.addEventListener('touchend', this, false);
    },

    onTouchMove: function(e) {
      this.moved = true;
    },

    onTouchEnd: function(e) {
      this.element.removeEventListener('touchmove', this, false);
      this.element.removeEventListener('touchend', this, false);

      if( !this.moved ) {
        // Place your code here or use the click simulation below
        var theTarget = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        if(theTarget.nodeType == 3) theTarget = theTarget.parentNode;

        var theEvent = document.createEvent('MouseEvents');
        theEvent.initEvent('click', true, true);
        theTarget.dispatchEvent(theEvent);
      }
    }
  };

  $('textarea#text').keyup(function() {
    $('#count').html($(this).val().length + '/200');
  });


  /*$('#new-comment .icon').each(function() {
    NoClickDelay(this); // Speed up taps, triggers onclick.
  });*/

  var weather = document.querySelector('#weather');
  NoClickDelay(weather);

  $('#new-comment .icon').toggle(function() {
    $(this).addClass('active');
    $('#new-comment input[name="type[' + $(this).attr('id') + ']"]').attr('checked', true);
  }, function() {
    $(this).removeClass('active');
    $('#new-comment input[name="type[' + $(this).attr('id') + ']"]').attr('checked', false);
  });
  $('#another-stop').click(function() {
    $('#stop_id').hide();
    $('#stop_form').show();
    window.scrollTo(0,0);
    $('#stop').val('').focus();
    return false;
  });
  $('#stop_id').click(function() {
    $(this).hide();
    $('#stop_form').show();
  });
  </script>
</div>
